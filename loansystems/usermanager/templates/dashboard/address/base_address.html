{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}
{% block title %} {% translate 'Manage Address' %}{% endblock %}
{% block content %}
{%  include 'base/navbar.html' %}

<div class="container-lg {% if sidebar.is_sidebar == True %} container-fluid {% endif %}">
    <div class="col-12 p-3 bg-light-subtle shadow my-4">
            <div class="d-flex justify-content-between">
                <a href="{% url 'address' %}" class="text-decoration-none text-dark d-flex align-items-center">
{#                <i class="ti-arrow-left mx-2"></i>#}
                <p>{% translate "Address" %}</p>
                </a>
                <div class="">
                    <a class="text-decoration-none text-dark" href="{% url 'loan' %}"><i class="ti-home"></i></a> /
                    {% translate 'Address List' %}
                </div>
            </div>
        </div>
    <div class="position-relative">
        <div class="row  my-3 justify-content-between pe-2">
            <div class=" col-10 position-relative" style="max-width: 450px;">
                <form action="" autocomplete="off" id="search-form" method="post" class="position-relative">
                    {% csrf_token %}
                    <div class="d-flex position-relative">
                          <input class="form-control border-end-0 border rounded-pill" type="text" name="search" id="search-input"  placeholder="{% translate 'Search Address' %}" >
                          <button class="position-absolute right-0 btn btn-outline-success bg-success text-white border-start-0 border rounded-pill ms-n3">
                              <i class="ti-search"></i>
                          </button>
                    </div>

                </form>
            </div>
        </div>
            <div class="bg-light not-visible shadow p-2 position-absolute border-top-0 w-100"  style=" z-index: 10; width: 100%" id="result-loan"></div>
        <hr>
    </div>
    <div class="row" style="height: 100vh; min-height: 100%;">
        <div class="col-12 col-sm-12 col-md-12">
        <div class=" table-responsive">
            <table class="table ">
                <thead>
                    <th> Customer</th>
                    <th> Country</th>
                    <th> Province</th>
                    <th> District</th>
                    <th> Commune</th>
                    <th> Village</th>
                </thead>
                <tbody>
                {% for address in addressData %}
                    <tr>
                        <td>{{ address.customer.name_kh }}</td>
                        <td>{{ address.country }}</td>
                        <td>{{ address.province }}</td>
                        <td>{{ address.district }}</td>
                        <td>{{ address.commune }}</td>
                        <td>{{ address.village }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
            <div class="d-flex justify-content-end mt-2 ">
                      {% if addressData.has_other_pages %}
                       <nav aria-label="Page navigation example">
                          <ul class="pagination">
                          {% if addressData.has_previous %}
                            <li class="page-item"><a class="page-link text-dark" href="?page={{ addressData.has_previous }}">{% translate 'Previous' %}</a></li>
                            {% else %}
                              <li class="page-item disabled"><a class="page-link">{% translate 'Previous' %}</a></li>
                            {% endif %}
                            {% for i in addressData.paginator.page_range %}
                              {% if addressData.number == i %}
                                <li class="page-item active"><span class="page-link">{{ i }} <span class="sr-only">(current)</span></span></li>
                              {% else %}
                                <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                              {% endif %}
                            {% endfor %}
                          {% if addressData.has_next %}
                            <li class="page-item" id="next"><a class="page-link text-dark" href="?page={{ addressData.has_next }}">{% translate 'Next' %}</a></li>
                              {% else %}
                              <li class="page-item disabled"><a class="page-link">{% translate 'Next' %}</a></li>
                          {% endif %}
                          </ul>
                           {% endif %}
                    </nav>
                </div>
        </div>
    </div>
</div>
    <script>
            const result_box = document.getElementById('result-loan');
            const search_form = document.getElementById('search-form')
            const search_input = document.getElementById('search-input');

            const csrf = document.getElementsByName('csrfmiddlewaretoken')[0].value
            search_input.addEventListener('keyup', e=> {
                // Now when keyup shw resul box
                if(result_box.classList.contains('not-visible')) {
                    result_box.classList.remove('not-visible')
                }
                // let get the search result
                sendSearchData(e.target.value)
            })
            const sendSearchData = (addressList) => {
                $.ajax({
                    type: 'POST',
                    url: '{% url "search_customerAddress" %}',
                    data: {
                        'csrfmiddlewaretoken': csrf,
                        'addressList': addressList,
                    },
                    success: (res) => {
                        const data = res.data
                        if (Array.isArray(data)){
                            let searchResults = ''
                            data.forEach(addressList => {
                                searchResults += `
                                    <a href="/customer-detail/${addressList.id}"
                                    class='w-100 bg-light-subtle shadow border-bottom-1 d-flex text-dark align-items-center text-decoration-none rounded-pill m-1 p-2'>
                                     <p class="mx-2">${addressList.name} (${addressList.name_kh}) </p>
                                     <p class="mx-2">${addressList.country} ${addressList.province}</p>
                                    </a>`
                            });
                            result_box.innerHTML = searchResults;
                        } else {
                            if(search_input.value.length > 0){
                                result_box.innerHTML = `<b class="bg-light w-100 d-flex justify-content-center p-3 text-center">${data}</b>`
                            } else {
                                result_box.classList.add('not-visible')
                            }
                        }
                    },
                    error: (err) => {
                        alert('this data has error!(-_-) please try again')
                        console.log(err)
                    }
                })
            }

    </script>

{% include 'base/footer.html' %}
{% endblock %}
